{"version":3,"file":"module.js","sources":["../src/ColorMaterial.ts","../src/ColorRenderPass.ts","../src/FramebufferPicker.ts"],"sourcesContent":["import { Engine, Logger, Material, RenderElement, Shader, Vector3 } from \"oasis-engine\";\nimport fs from \"./color.fs.glsl\";\nimport vs from \"./color.vs.glsl\";\n\nShader.create(\"framebuffer-picker-color\", vs, fs);\n\n/**\n * Color material, render as marker.\n */\nexport class ColorMaterial extends Material {\n  private _currentId: number = 0;\n  private _primitivesMap = [];\n\n  constructor(engine: Engine) {\n    super(engine, Shader.find(\"framebuffer-picker-color\"));\n  }\n\n  /**\n   * Reset id and renderer element table.\n   */\n  reset(): void {\n    this._currentId = 0;\n    this._primitivesMap = [];\n  }\n\n  /**\n   * Convert id to RGB color value, 0 and 0xffffff are illegal values.\n   */\n  id2Color(id: number): Vector3 {\n    if (id >= 0xffffff) {\n      Logger.warn(\"Framebuffer Picker encounter primitive's id greater than \" + 0xffffff);\n      return new Vector3(0, 0, 0);\n    }\n\n    const color = new Vector3((id & 0xff) / 255, ((id & 0xff00) >> 8) / 255, ((id & 0xff0000) >> 16) / 255);\n    return color;\n  }\n\n  /**\n   * Convert RGB color to id.\n   * @param color - Color\n   */\n  color2Id(color): number {\n    return color[0] | (color[1] << 8) | (color[2] << 16);\n  }\n\n  /**\n   * Get renderer element by color.\n   */\n  getObjectByColor(color) {\n    return this._primitivesMap[this.color2Id(color)];\n  }\n\n  /**\n   * @override\n   */\n  _preRender(renderElement: RenderElement) {\n    const { component, mesh } = renderElement;\n    this._currentId += 1;\n    this._primitivesMap[this._currentId] = { component, mesh };\n    component.shaderData.setVector3(\"u_colorId\", this.id2Color(this._currentId));\n  }\n}\n","import { Camera, Engine, Layer, RenderPass, RenderTarget } from \"oasis-engine\";\nimport { ColorMaterial } from \"./ColorMaterial\";\n\n/**\n * Color render Pass, used to render marker.\n */\nclass ColorRenderPass extends RenderPass {\n  private _needPick: boolean;\n  private onPick: Function;\n  private _pickPos;\n\n  constructor(name: string, priority: number, renderTarget: RenderTarget, mask: Layer, engine?: Engine) {\n    super(name, priority, renderTarget, new ColorMaterial(engine), mask);\n\n    this._needPick = false;\n    this.onPick = (o: any) => console.log(o);\n  }\n\n  /**\n   * Determine whether need to render pass, reset state.\n   * @override\n   */\n  preRender() {\n    if (this._needPick) {\n      this.enabled = true;\n      (this.replaceMaterial as ColorMaterial).reset();\n    } else {\n      this.enabled = false;\n    }\n  }\n\n  /**\n   * Determine whether to pick up.\n   * @override\n   */\n  postRender(camera: Camera) {\n    if (this._needPick) {\n      const color = this.readColorFromRenderTarget(camera);\n      const object = (this.replaceMaterial as ColorMaterial).getObjectByColor(color);\n      this._needPick = false;\n\n      if (this.onPick) this.onPick(object);\n    }\n  }\n\n  /**\n   * Pick up coordinate pixels.\n   */\n  pick(x: number, y: number) {\n    this._pickPos = [x, y];\n    this._needPick = true;\n  }\n\n  /**\n   * Get pixel color value from framebuffer.\n   */\n  readColorFromRenderTarget(camera: Camera) {\n    const gl = camera.engine._hardwareRenderer.gl;\n    const screenPoint = this._pickPos;\n    const canvas = gl.canvas;\n    const clientWidth = canvas.clientWidth;\n    const clientHeight = canvas.clientHeight;\n    const canvasWidth = gl.drawingBufferWidth;\n    const canvasHeight = gl.drawingBufferHeight;\n\n    const px = (screenPoint[0] / clientWidth) * canvasWidth;\n    const py = (screenPoint[1] / clientHeight) * canvasHeight;\n\n    const viewport = camera.viewport;\n    const viewWidth = (viewport.z - viewport.x) * canvasWidth;\n    const viewHeight = (viewport.w - viewport.y) * canvasHeight;\n\n    const nx = (px - viewport.x) / viewWidth;\n    const ny = (py - viewport.y) / viewHeight;\n    const left = Math.floor(nx * (this.renderTarget.width - 1));\n    const bottom = Math.floor((1 - ny) * (this.renderTarget.height - 1));\n    const pixel = new Uint8Array(4);\n\n    this.renderTarget.getColorTexture().getPixelBuffer(null, left, bottom, 1, 1, pixel);\n    return pixel;\n  }\n}\n\nexport { ColorRenderPass };\n","import { Camera, Entity, RenderColorTexture, RenderTarget, Script } from \"oasis-engine\";\nimport { ColorRenderPass } from \"./ColorRenderPass\";\n\n/**\n * Framebuffer picker.\n * @remarks Can pick up renderer at pixel level.\n */\nexport class FramebufferPicker extends Script {\n  public colorRenderTarget: RenderTarget;\n  public colorRenderPass: ColorRenderPass;\n\n  private _camera: Camera;\n  private _needPick: boolean;\n  private _pickPos: [number, number];\n\n  /**\n   * Camera.\n   */\n  get camera(): Camera {\n    return this._camera;\n  }\n\n  set camera(value: Camera) {\n    if (this._camera !== value) {\n      this._camera = value;\n      //@ts-ignore\n      this.camera._renderPipeline.addRenderPass(this.colorRenderPass);\n    }\n  }\n\n  constructor(entity: Entity) {\n    super(entity);\n    const width = 1024;\n    const height = 1024;\n    this.colorRenderTarget = new RenderTarget(\n      this.engine,\n      width,\n      height,\n      new RenderColorTexture(this.engine, width, height)\n    );\n    this.colorRenderPass = new ColorRenderPass(\"ColorRenderTarget_FBP\", -1, this.colorRenderTarget, 0, this.engine);\n  }\n\n  /**\n   * Set the callback function after pick up.\n   * @param {Function} fun Callback function. if there is an renderer selected, the parameter 1 is {component, primitive }, otherwise it is undefined\n   */\n  set onPick(fun: Function) {\n    if (typeof fun === \"function\") {\n      (this.colorRenderPass as any).onPick = fun;\n    }\n  }\n\n  /**\n   * Pick the object at the screen coordinate position.\n   * @param offsetX Relative X coordinate of the canvas\n   * @param offsetY Relative Y coordinate of the canvas\n   */\n  pick(offsetX: number, offsetY: number) {\n    if (this.enabled) {\n      this._needPick = true;\n      this._pickPos = [offsetX, offsetY];\n    }\n  }\n\n  onUpdate(deltaTime: number) {\n    super.onUpdate(deltaTime);\n\n    if (this.enabled && this._needPick) {\n      this.colorRenderPass.pick(this._pickPos[0], this._pickPos[1]);\n      this._needPick = false;\n    }\n  }\n\n  onDestroy() {\n    if (!this.camera.destroyed) {\n      //@ts-ignore\n      this.camera._renderPipeline.removeRenderPass(this.colorRenderPass);\n    }\n  }\n}\n"],"names":["Shader","create","vs","fs","ColorMaterial","engine","find","_currentId","_primitivesMap","reset","id2Color","id","Logger","warn","Vector3","color","color2Id","getObjectByColor","_preRender","renderElement","component","mesh","shaderData","setVector3","Material","ColorRenderPass","name","priority","renderTarget","mask","_needPick","onPick","_pickPos","o","console","log","preRender","enabled","replaceMaterial","postRender","camera","readColorFromRenderTarget","object","pick","x","y","gl","_hardwareRenderer","screenPoint","canvas","clientWidth","clientHeight","canvasWidth","drawingBufferWidth","canvasHeight","drawingBufferHeight","px","py","viewport","viewWidth","z","viewHeight","w","nx","ny","left","Math","floor","width","bottom","height","pixel","Uint8Array","getColorTexture","getPixelBuffer","RenderPass","FramebufferPicker","entity","colorRenderTarget","colorRenderPass","_camera","RenderTarget","RenderColorTexture","offsetX","offsetY","onUpdate","deltaTime","onDestroy","destroyed","_renderPipeline","removeRenderPass","value","addRenderPass","fun","Script"],"mappings":"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"}