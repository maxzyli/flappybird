!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("oasis-engine")):"function"==typeof define&&define.amd?define(["exports","oasis-engine"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self)["@oasisEngine/framebufferPicker"]={},e.oasisEngine)}(this,(function(e,n){"use strict";function r(e,n){for(var r=0;r<n.length;r++){var i=n[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,n){e.prototype=Object.create(n.prototype),e.prototype.constructor=e,t(e,n)}function t(e,n){return t=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e},t(e,n)}n.Shader.create("framebuffer-picker-color","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <blendShape_input>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <position_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\nuniform vec3 u_colorId;void main(){gl_FragColor=vec4(u_colorId,1.0);}");var o=function(e){function r(r){var i;return(i=e.call(this,r,n.Shader.find("framebuffer-picker-color"))||this)._currentId=0,i._primitivesMap=[],i}i(r,e);var t=r.prototype;return t.reset=function(){this._currentId=0,this._primitivesMap=[]},t.id2Color=function(e){return e>=16777215?(n.Logger.warn("Framebuffer Picker encounter primitive's id greater than 16777215"),new n.Vector3(0,0,0)):new n.Vector3((255&e)/255,((65280&e)>>8)/255,((16711680&e)>>16)/255)},t.color2Id=function(e){return e[0]|e[1]<<8|e[2]<<16},t.getObjectByColor=function(e){return this._primitivesMap[this.color2Id(e)]},t._preRender=function(e){var n=e.component,r=e.mesh;this._currentId+=1,this._primitivesMap[this._currentId]={component:n,mesh:r},n.shaderData.setVector3("u_colorId",this.id2Color(this._currentId))},r}(n.Material),c=function(e){function n(n,r,i,t,c){var a;return(a=e.call(this,n,r,i,new o(c),t)||this)._needPick=void 0,a.onPick=void 0,a._pickPos=void 0,a._needPick=!1,a.onPick=function(e){return console.log(e)},a}i(n,e);var r=n.prototype;return r.preRender=function(){this._needPick?(this.enabled=!0,this.replaceMaterial.reset()):this.enabled=!1},r.postRender=function(e){if(this._needPick){var n=this.readColorFromRenderTarget(e),r=this.replaceMaterial.getObjectByColor(n);this._needPick=!1,this.onPick&&this.onPick(r)}},r.pick=function(e,n){this._pickPos=[e,n],this._needPick=!0},r.readColorFromRenderTarget=function(e){var n=e.engine._hardwareRenderer.gl,r=this._pickPos,i=n.canvas,t=i.clientWidth,o=i.clientHeight,c=n.drawingBufferWidth,a=n.drawingBufferHeight,s=r[0]/t*c,d=r[1]/o*a,u=e.viewport,l=(u.z-u.x)*c,f=(u.w-u.y)*a,h=(s-u.x)/l,p=(d-u.y)/f,_=Math.floor(h*(this.renderTarget.width-1)),g=Math.floor((1-p)*(this.renderTarget.height-1)),P=new Uint8Array(4);return this.renderTarget.getColorTexture().getPixelBuffer(null,_,g,1,1,P),P},n}(n.RenderPass),a=function(e){function t(r){var i;(i=e.call(this,r)||this).colorRenderTarget=void 0,i.colorRenderPass=void 0,i._camera=void 0,i._needPick=void 0,i._pickPos=void 0;return i.colorRenderTarget=new n.RenderTarget(i.engine,1024,1024,new n.RenderColorTexture(i.engine,1024,1024)),i.colorRenderPass=new c("ColorRenderTarget_FBP",-1,i.colorRenderTarget,0,i.engine),i}i(t,e);var o,a,s,d=t.prototype;return d.pick=function(e,n){this.enabled&&(this._needPick=!0,this._pickPos=[e,n])},d.onUpdate=function(n){e.prototype.onUpdate.call(this,n),this.enabled&&this._needPick&&(this.colorRenderPass.pick(this._pickPos[0],this._pickPos[1]),this._needPick=!1)},d.onDestroy=function(){this.camera.destroyed||this.camera._renderPipeline.removeRenderPass(this.colorRenderPass)},o=t,(a=[{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this.camera._renderPipeline.addRenderPass(this.colorRenderPass))}},{key:"onPick",set:function(e){"function"==typeof e&&(this.colorRenderPass.onPick=e)}}])&&r(o.prototype,a),s&&r(o,s),t}(n.Script);e.FramebufferPicker=a,Object.defineProperty(e,"__esModule",{value:!0})}));
